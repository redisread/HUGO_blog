---
title: "ES原理和实践：底层lucene"
date: 2024-02-24T23:26:32+08:00
description: ES是基于Lucene这个库实现的一个搜索引擎，我的理解是，Lucene主要实现一些底层结构设计和查询、写入的极致优化；而ES是对Lucene进行封装使用，实现分布式、高可用、高可拓展等特性。
draft: true
hideToc: false
enableToc: true
enableTocContent: false
tocPosition: inner
author: VictorHong
authorEmoji: 🪶
image: https://cos.jiahongw.com/uPic/image-20230225105212461.png
tocLevels: ["h2", "h3", "h4"]
libraries:
tags:
- elasticsearch
- lucene
series:
- ES原理和实践
categories:
- elasticsearch
---

## ES 和 lucene 的关系

- lucene：lucene 是一个 Java 信息检索程序库。可以类比为封装的底层 API，程序引用这个库之后可以使用其中的一些功能。
- ES：ES 是基于 lucene 这个包基础上进行构建的一个满足高可用、高性能、高可拓展的分布式存储中间件。

![ES和lucene关系](https://cos.jiahongw.com/uPic/POa8qK.png)

## Lucene 的底层数据结构设计

Lucene 是一个高效的，基于 Java 的全文检索库。主要包括下面的一些核心操作：
![lucene核心操作](https://cos.jiahongw.com/uPic/aefxFy.png)


### 倒排索引

{{< alert theme="info" >}}
**什么是倒排索引？**
首先看下什么是正排索引:
	MySQL中，根据id可以直接查找到数据行，那么id这个查询条件使用的就是**正排索引**；可以理解为，**正排索引就是从文档id到文档内容映射。**

那什么是倒排索引？
	ES将数据进行**分词**之后，存储到倒排索引中。分词之后会分成多个字符串值，倒排索引存储的就是这些字符串值到文档id的映射。可以理解为，**倒排索引就是从字段到文档id的映射**。
{{< /alert >}}

为什么使用倒排索引呢？倒排索引最后不也是拿到文档id进行查询文档，使用正排索引不是也能满足需求吗？


案例1：搜索引擎

搜索引擎一般是搜索网页上的内容，而网页上的内容一般是文章，此时我们一般使用关键字去查询相关网页的文章，而文章的内容是比较长的，如果使用MySQL这种数据库去查询的话，需要类似like %关键字%去查询，我们知道MySQL满足前缀匹配才会查找索引的，这样的查询会直接导致全表扫描，查询性能极低。其实，就算是构建索引，对于文章内容构建索引也是不现实的。

使用ES可以先对文章进行分词，然后将每个词项对应的倒排列表存入ES的倒排索引中，这样通过关键字找相关的网页文章就像哈希查找一样快（直接就避免了线性的全表扫描）。ES倒排索引将文章这种非结构化的数据进行分词整理，转换成结构化的倒排列表存储起来，在进行关键字的全文索引能够达到非常好的效果。

案例2：电商搜索系统

电商搜索系统一般来说需要比较快的查询响应速度，不然用户体验不好商品的销量也就较低。通常，电商搜索系统，例如淘宝、京东、咸鱼、拼多多等，在进行商品搜索的时候，可以按照商品的名称进行模糊搜索，除此之外，还能对商品进行各种各样的筛选：分类、品牌、价格、特征、尺码、包装形式、是否折扣、发货地......

首先，为保证快速的进行搜索，在MySQL是否应该对各种筛选项进行添加索引，如果添加索引的话，MySQL的索引就会极度膨胀，会直接影响写入的性能。而ES默认所有字段都是索引，对于这种多条件的查询可以说是得心应手的。其次，商品名称的模糊查询也注定不能使用MySQL了。











