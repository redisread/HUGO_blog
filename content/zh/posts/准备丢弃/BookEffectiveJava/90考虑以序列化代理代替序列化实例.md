---
title: 90è€ƒè™‘ä»¥åºåˆ—åŒ–ä»£ç†ä»£æ›¿åºåˆ—åŒ–å®ä¾‹
date: 2021-11-21T14:14:46+08:00
description:
draft: true
hideToc: false
enableToc: true
enableTocContent: false
tocPosition: outer
author: Victor
authorEmoji: ğŸª¶
image:
plantuml: true
libraries:
- katex
- mathjax
tags:
-
series:
-
categories:
-
---



> å®ç° Serializable æ¥å£çš„å†³å®šå¢åŠ äº†å‡ºç° bug å’Œå®‰å…¨é—®é¢˜çš„å¯èƒ½æ€§ï¼Œå› ä¸ºå®ƒå…è®¸ä½¿ç”¨ä¸€ç§è¶…è¯­è¨€æœºåˆ¶æ¥åˆ›å»ºå®ä¾‹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨æ™®é€šçš„æ„é€ å‡½æ•°ã€‚ç„¶è€Œï¼Œæœ‰ä¸€ç§æŠ€æœ¯å¯ä»¥å¤§å¤§é™ä½è¿™äº›é£é™©ã€‚è¿™ç§æŠ€æœ¯ç§°ä¸ºåºåˆ—åŒ–ä»£ç†æ¨¡å¼ã€‚

å¦‚ä½•å®ç°åºåˆ—åŒ–ä»£ç† æ¨¡å¼ï¼Ÿ

1. ä¸ºå¯åºåˆ—åŒ–çš„ç±»è®¾è®¡ä¸€ä¸ªç§æœ‰çš„é™æ€åµŒå¥—ç±»(åºåˆ—åŒ–ä»£ç†), å®ƒåº”è¯¥æœ‰ä¸€ä¸ªå•ç‹¬çš„æ„é€ å™¨, å…¶å‚æ•°ç±»å‹å°±æ˜¯é‚£ä¸ªå¤–å›´ç±».

2. åœ¨å¤–å›´ç±»ä¸­æ·»åŠ writeReplaceæ–¹æ³•. -> äº§ç”Ÿä»£ç†ç±»å®ä¾‹.

   è¿™ä¸ªæ–¹æ³•çš„å­˜åœ¨å¯¼è‡´åºåˆ—åŒ–ç³»ç»Ÿäº§ç”Ÿä¸€ä¸ªSerializationProxy å®ä¾‹ï¼Œä»£æ›¿å¤–å›´ç±»çš„å®ä¾‹ã€‚æ¢å¥è¯è¯´ï¼Œ writeReplace æ–¹æ³•åœ¨åºåˆ—åŒ–ä¹‹å‰ï¼Œå°†å¤–å›´ç±»çš„å®ä¾‹è½¬å˜æˆäº†å®ƒçš„åºåˆ—åŒ–ä»£ç†ã€‚

3. å¤–å›´ç±»ä¸­æ·»åŠ readObjectæ–¹æ³•. -> é˜²æ­¢ä¼ªé€ .

4. ä»£ç†ç±»ä¸­æä¾›readResolveæ–¹æ³•, è¿”å›ä¸€ä¸ªé€»è¾‘ä¸Šç›¸å½“çš„å¤–å›´ç±»çš„å®ä¾‹. -> åºåˆ—åŒ–ä»£ç†è½¬å˜å›å¤–å›´ç±»çš„å®ä¾‹.

ä¸€ä¸ªä¾‹å­ï¼š

```java
/**
 * 1. åºåˆ—åŒ–Dogæ—¶, ä¼šè°ƒç”¨è°ƒç”¨writeReplace()ç”Ÿæˆä¸€ä¸ªDogProxyå¯¹è±¡, ç„¶åå¯¹æ­¤å¯¹è±¡è¿›è¡Œåºåˆ—åŒ– (ä¸æ˜¯å¯¹Dogç±»å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–,
 *      ç”±åºåˆ—åŒ–æ–‡ä»¶çš„å†…å®¹å¯ä»¥å¾—çŸ¥, å¯ä»¥æŸ¥çœ‹åºåˆ—åŒ–ç”Ÿæˆçš„æ–‡ä»¶, æ–‡ä»¶ä¸­å†…å®¹ä¸ºå¦‚ä¸‹å›¾ (ä»£ç ä¹‹åçš„å›¾)
 * 2. ååºåˆ—åŒ–æ—¶, ä¼šè°ƒç”¨DogProxyçš„readResolve()æ–¹æ³•ç”Ÿæˆä¸€ä¸ªDogå¯¹è±¡, 
 *      æœ€åè¿”å›æ­¤å¯¹è±¡çš„æ‹·è´ (é€šè¿‡DogProxyç±»çš„readResolveæ–¹æ³•å’Œmainæ–¹æ³•ä¸­çš„è¾“å‡ºå¯ä»¥çœ‹å‡º)
 * 3. å› æ­¤, Dogç±»çš„åºåˆ—åŒ–å·¥ä½œå®Œå…¨äº¤ç»™DogProxyç±», æ­£å¦‚æ­¤æ¨¡å¼çš„åç§°æ‰€è¡¨è¾¾çš„ä¸€æ ·
 */
public class Dog implements Serializable{
    private static final long serialVersionUID = -8424740460257438938L;
    
    private String name;
    private int age;
    
    public Dog(String name,int age) {
        //çº¦æŸæ¡ä»¶
        if(age < 0 || age > 100) {
            throw new IllegalArgumentException("éæ³•å¹´é¾„");
        }
        this.name = name;
        this.age = age;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }

    /** åºåˆ—åŒ–ä»£ç†å†…éƒ¨ç±» */
    private static class DogProxy implements Serializable{
        private static final long serialVersionUID = -8883457811799334207L;

        private String name;
        private int age;

        public DogProxy(Dog dog) {
            this.name = dog.getName();
            this.age = dog.getAge();
        }
        
        /** ååºåˆ—åŒ–æ—¶, æ›¿æ¢è¿”å›çš„å¯¹è±¡(æ¯”å–»å·å¤©æ¢æ—¥å§) */
        private Object readResolve() {
            return new Dog(name,age);
        }

        /** è‡ªå®šä¹‰åºåˆ—åŒ–å½¢å¼ */
        private void writeObject(ObjectOutputStream out) throws IOException {
            out.defaultWriteObject();
            System.out.println("SerializationProxy writeObject, è°ƒç”¨");
        }

        /** è‡ªå®šä¹‰ååºåˆ—åŒ–å½¢å¼ */
        private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException {
            in.defaultReadObject();
            System.out.println("SerializationProxy readObject, è°ƒç”¨");
        }
        
    }

    /** åºåˆ—åŒ–æ—¶, æŠŠthis=Dogå¯¹è±¡æ›¿æ¢ä¸ºåºåˆ—åŒ–ä»£ç†å¯¹è±¡ */
    private Object writeReplace() {
        return new DogProxy(this);//readObjectçš„æ—¶å€™æ˜¯è°ƒç”¨, DogProxyçš„readResolve()
    }

    /** æ­¤æ–¹æ³•ä¸ä¼šæ‰§è¡Œ */
    private void writeObject(ObjectOutputStream out) {
        System.out.println("Dog writeObject, ä¸ä¼šè°ƒç”¨");
    }
    
    /** é˜²æ­¢æ”»å‡»è€…ä¼ªé€ æ•°æ®, ä¼å›¾è¿åçº¦æŸæ¡ä»¶ (å¦‚: è¿åå¹´é¾„çº¦æŸ) */
    private void readObject(ObjectInputStream in) throws Exception {
        throw new Exception("proxy required");
    }
    
}
```

æœ‰ç‚¹ç±»ä¼¼å»ºé€ è€…æ¨¡å¼ã€‚

ä½¿ç”¨ï¼š

```java
public class Test {

    public static void main(String[] args) throws IOException, ClassNotFoundException {
        Dog dog = new Dog("å°ç™½",12);
        ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream("D:\\temp"));
        out.writeObject(dog);
        out.flush();
        out.close();
        
        
        ObjectInputStream in = new ObjectInputStream(new FileInputStream("D:\\temp"));
        Dog deserDog = (Dog)in.readObject();
        in.close();
        
        System.out.println(deserDog.getAge());
        System.out.println(deserDog.getName());
        
        if(dog == deserDog) {
            System.out.println("åºåˆ—åŒ–å‰åæ˜¯åŒä¸€ä¸ªå¯¹è±¡");
        } else {
            //ç¨‹åºä¼šèµ°è¿™ä¸€æ®µ, ååºåˆ—åŒ–ä¼šåˆ›å»ºå¯¹è±¡, ä½†æ˜¯ä¸ä¼šæ‰§è¡Œç±»çš„æ„é€ æ–¹æ³•, è€Œæ˜¯ä½¿ç”¨è¾“å…¥æµæ„é€ å¯¹è±¡
            System.out.println("åºåˆ—åŒ–å‰åä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡, å“ˆå“ˆå“ˆ");
        }
        
    }
    
}
```

å±€é™ï¼š

- ä¸èƒ½ä¸å¯ä»¥è¢«å®¢æˆ·ç«¯æ‰©å±•çš„ç±»å…¼å®¹.
- ä¸èƒ½ä¸å¯¹è±¡å›¾ä¸­åŒ…å«å¾ªç¯çš„æŸäº›ç±»å…¼å®¹.
- åºåˆ—åŒ–ä»£ç†æ¨¡å¼çš„åŠŸèƒ½å’Œå®‰å…¨æ€§æœ‰æ€§èƒ½å¼€é”€çš„ä»£ä»·.

æ€»è€Œè¨€ä¹‹, æ¯å½“ä½ å‘ç°è‡ªå·±å¿…é¡»åœ¨ä¸€ä¸ªä¸èƒ½è¢«å®¢æˆ·ç«¯æ‰©å±•çš„ç±»ä¸Šç¼–å†™readObjectæˆ–è€…writeObjectæ–¹æ³•çš„æ—¶å€™, å°±åº”è¯¥è€ƒè™‘ä½¿ç”¨åºåˆ—åŒ–ä»£ç†æ¨¡å¼.

---

***Reference***:

1. [Effective-Java-3rd-edition-Chinese-English-bilingual/Chapter-12-Item-90-Consider-serialization-proxies-instead-of-serialized-instances.md at dev Â· clxering/Effective-Java-3rd-edition-Chinese-English-bilingual](https://github.com/clxering/Effective-Java-3rd-edition-Chinese-English-bilingual/blob/dev/Chapter-12/Chapter-12-Item-90-Consider-serialization-proxies-instead-of-serialized-instances.md)
