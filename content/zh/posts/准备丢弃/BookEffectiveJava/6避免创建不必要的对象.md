---
title: 6-避免创建不必要的对象
date: 2021-10-24T23:43:49+08:00
description: Avoid creating unnecessary objects.
draft: true
hideToc: false
enableToc: true
enableTocContent: false
tocPosition: outer
author: Victor
authorEmoji: 🪶
image:
plantuml: true
libraries:
- katex
- mathjax
tags:
- EffectiveJava
series:
- EffectiveJava
categories:
-
---



<!--第二章：创建和销毁对象-->

### 为什么会创建不必要的对象

显然，这是一个大家都知道的道理，没必要的对象当然最好不要创建。但是，有些时候，我们会不经意间创建了对象。

虽然Java处处都是引用，但是，请考虑下面的语句：

```java
String s = new String("bikini"); // DON'T DO THIS!
```

**当我们使用 `new` 关键字进行创建对象的时候，不管什么情况，都会创建一个新的对象。**

但是，对于String，当我们执行：

```java
String s1 = "111";
String s2 = s1;
```

此时s2和s1指向的是同一个对象。因为Java内部默认将String作为不可变的对象，并且将它们进行缓存起来，当是一样的字符串的时候，就不会新建一个对象。

### 如何避免创建不必要的对象

#### 1 避免自动的装箱和拆箱

虽然自动装箱方便了程序员进行开发。但是我们还是需要避免不必要的装箱和拆箱。考虑下面的情况：

```java
private static long sum() {
    Long sum = 0L;
    for (long i = 0; i <= Integer.MAX_VALUE; i++)
        sum += i; // 发生装箱
    return sum; // 发生拆箱
}
```

> 装箱拆箱混合合基本类型和包装类型

每一次从基本类型（例如：int、long）自动转换成包装类型（例如：Integer、Long），都会发生装箱操作，反过来也是，会发生拆箱操作。这个在一两次执行还好，但是当执行了多次这种无意义的操作之后，性能还是会下降的。

最好的方法是统一数据类型：

```java
private static long sum() {
    long sum = 0L;
    for (long i = 0; i <= Integer.MAX_VALUE; i++)
        sum += i; // 发生装箱
    return sum; // 发生拆箱
}
```

> **基本类型优于包装类，还应提防意外的自动装箱。**

#### 2 使用静态关键字缓存对象

例如，工厂方法比构造函数更好。构造函数每次调用时都必须创建一个新对象，而工厂方法从来不需要这样做，在实际应用中也不会这样做。除了复用不可变对象之外，如果知道可变对象不会被修改，也可以复用它们。

有些对象的创建的代价相比而言要昂贵得多。如果你需要重复地使用这样一个「昂贵的对象」，那么最好将其缓存以供复用。

```java
// Performance can be greatly improved!
static boolean isRomanNumeral(String s) {
    return s.matches("^(?=.)M*(C[MD]|D?C{0,3})" + "(X[CL]|L?X{0,3})(I[XV]|V?I{0,3})$");
}
```

使用static进行优化：

```java
// Reusing expensive object for improved performance
public class RomanNumerals {
    private static final Pattern ROMAN = Pattern.compile("^(?=.)M*(C[MD]|D?C{0,3})" + "(X[CL]|L?X{0,3})(I[XV]|V?I{0,3})$");
    static boolean isRomanNumeral(String s) {
        return ROMAN.matcher(s).matches();
    }
}
```

### 总结

这个建议不应该被曲解为是在暗示创建对象是成本昂贵的，应该避免。相反，**创建和回收这些小对象的构造函数成本是很低廉的，尤其是在现代 JVM 实现上**。创建额外的对象来增强程序的清晰性、简单性或功能通常是件好事。但是对于代价比较大的对象无意义创建，还是应该避免。

---

***Reference***:

1. [Item 6: Avoid creating unnecessary objects（避免创建不必要的对象）](https://github.com/clxering/Effective-Java-3rd-edition-Chinese-English-bilingual/blob/dev/Chapter-2/Chapter-2-Item-6-Avoid-creating-unnecessary-objects.md)
