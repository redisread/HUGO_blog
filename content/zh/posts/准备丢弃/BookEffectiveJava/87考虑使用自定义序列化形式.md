---
title: 87è€ƒè™‘ä½¿ç”¨è‡ªå®šä¹‰åºåˆ—åŒ–å½¢å¼
date: 2021-11-21T00:06:44+08:00
description:
draft: true
hideToc: false
enableToc: true
enableTocContent: false
tocPosition: outer
author: Victor
authorEmoji: ğŸª¶
image:
plantuml: true
libraries:
- katex
- mathjax
tags:
-
series:
-
categories:
-
---



**å¦‚æœäº‹å…ˆæ²¡æœ‰è®¤çœŸè€ƒè™‘é»˜è®¤çš„åºåˆ—åŒ–å½¢å¼æ˜¯å¦åˆé€‚ï¼Œåˆ™ä¸è¦è´¸ç„¶æ¥å—ã€‚**

å¦‚æœä¸€ä¸ªå¯¹è±¡çš„ç‰©ç†è¡¨ç¤ºæ³•ç­‰åŒäºå®ƒçš„é€»è¾‘å†…å®¹ï¼Œå¯èƒ½å°±é€‚åˆäºä½¿ç”¨é»˜è®¤çš„åºåˆ—åŒ–å½¢å¼ã€‚

å³ä½¿ä½ ç¡®å®šäº†é»˜è®¤çš„åºåˆ—åŒ–å½¢å¼æ˜¯åˆé€‚çš„ï¼Œé€šå¸¸è¿˜å¿…é¡»æä¾›ä¸€ä¸ªreadObjectæ–¹æ³•ä»¥ä¿è¯çº¦æŸå…³ç³»å’Œå®‰å…¨æ€§ã€‚readObjectæ˜¯ååºåˆ—åŒ–æ—¶çš„å‡½æ•°ã€‚

> transient ä¿®é¥°ç¬¦è¡¨ç¤ºè¦ä»ç±»çš„é»˜è®¤åºåˆ—åŒ–è¡¨å•ä¸­çœç•¥è¯¥å®ä¾‹å­—æ®µ

**å½“å¯¹è±¡çš„ç‰©ç†è¡¨ç¤ºä¸å…¶é€»è¾‘æ•°æ®å†…å®¹æœ‰å¾ˆå¤§å·®å¼‚æ—¶ï¼Œä½¿ç”¨é»˜è®¤çš„åºåˆ—åŒ–å½¢å¼æœ‰å››ä¸ªç¼ºç‚¹**

1. å®ƒå°†å¯¼å‡ºçš„ API æ°¸ä¹…åœ°ç»‘å®šåˆ°å½“å‰çš„å†…éƒ¨å®ç°
2. å®ƒä¼šå ç”¨è¿‡å¤šçš„ç©ºé—´
3. å®ƒä¼šæ¶ˆè€—è¿‡å¤šçš„æ—¶é—´
4. å®ƒå¯èƒ½å¯¼è‡´å †æ ˆæº¢å‡º

ä¸€ä¸ªåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ä¾‹å­ï¼š

```java
// StringList with a reasonable custom serialized form
public final class StringList implements Serializable {
    private transient int size = 0;
    private transient Entry head = null;
    // No longer Serializable!

    private static class Entry {
        String data;
        Entry next;
        Entry previous;
    }
    // Appends the specified string to the list
    public final void add(String s) { ... }

    /**
    * Serialize this {@code StringList} instance.
    **
    @serialData The size of the list (the number of strings
    * it contains) is emitted ({@code int}), followed by all of
    * its elements (each a {@code String}), in the proper
    * sequence.
    */
    private void writeObject(ObjectOutputStream s) throws IOException {
        s.defaultWriteObject();
        s.writeInt(size);
        // Write out all elements in the proper order.
        for (Entry e = head; e != null; e = e.next)
            s.writeObject(e.data);
    }

    private void readObject(ObjectInputStream s) throws IOException, ClassNotFoundException {
        s.defaultReadObject();
        int numElements = s.readInt();
        // Read in all elements and insert them in list
        for (int i = 0; i < numElements; i++)
            add((String) s.readObject());
    }

    ... // Remainder omitted
}
```

> writeObject åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯è°ƒç”¨ defaultWriteObject, readObject åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯è°ƒç”¨ defaultReadObjectï¼Œå³ä½¿ StringList çš„æ‰€æœ‰å­—æ®µéƒ½æ˜¯ transient çš„ã€‚

å¯¹äº StringListï¼Œé»˜è®¤çš„åºåˆ—åŒ–å½¢å¼æ˜¯ä¸çµæ´»çš„ï¼Œå¹¶ä¸”æ‰§è¡Œå¾—å¾ˆç³Ÿç³•ï¼Œä½†æ˜¯å®ƒæ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºåºåˆ—åŒ–å’Œååºåˆ—åŒ– StringList å®ä¾‹ä¼šç”ŸæˆåŸå§‹å¯¹è±¡çš„æ— å·®é”™å‰¯æœ¬ï¼Œè€Œæ‰€æœ‰ä¸å˜é‡éƒ½æ˜¯å®Œæ•´çš„ã€‚å¯¹äºä»»ä½•ä¸å˜é‡ç»‘å®šåˆ°ç‰¹å®šäºå®ç°çš„ç»†èŠ‚çš„å¯¹è±¡ï¼Œæƒ…å†µå¹¶éå¦‚æ­¤ã€‚

> è€ƒè™‘å“ˆå¸Œè¡¨çš„æƒ…å†µã€‚ç‰©ç†è¡¨ç¤ºæ˜¯åŒ…å«ã€Œé”®-å€¼ã€é¡¹çš„å“ˆå¸Œæ¡¶åºåˆ—ã€‚ä¸€ä¸ªé¡¹æ‰€åœ¨çš„æ¡¶æ˜¯å…¶é”®çš„æ•£åˆ—ä»£ç çš„å‡½æ•°ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œä¸èƒ½ä¿è¯ä»ä¸€ä¸ªå®ç°åˆ°å¦ä¸€ä¸ªå®ç°æ˜¯ç›¸åŒçš„ã€‚äº‹å®ä¸Šï¼Œå®ƒç”šè‡³ä¸èƒ½ä¿è¯æ¯æ¬¡è¿è¡Œéƒ½æ˜¯ç›¸åŒçš„ã€‚å› æ­¤ï¼Œæ¥å—å“ˆå¸Œè¡¨çš„é»˜è®¤åºåˆ—åŒ–å½¢å¼å°†æ„æˆä¸¥é‡çš„ bugã€‚å¯¹å“ˆå¸Œè¡¨è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–å¯èƒ½ä¼šäº§ç”Ÿä¸€ä¸ªä¸å˜é‡ä¸¥é‡æŸåçš„å¯¹è±¡ã€‚

å¦‚æœä½¿ç”¨é»˜è®¤çš„åºåˆ—åŒ–å½¢å¼ï¼Œå¹¶ä¸”æ ‡è®°äº†ä¸€ä¸ªæˆ–å¤šä¸ªå­—æ®µä¸º transientï¼Œè¯·è®°ä½ï¼Œå½“ååºåˆ—åŒ–å®ä¾‹æ—¶ï¼Œè¿™äº›å­—æ®µå°†åˆå§‹åŒ–ä¸ºé»˜è®¤å€¼ï¼šå¯¹è±¡å¼•ç”¨å­—æ®µä¸º nullï¼Œæ•°å­—åŸºæœ¬ç±»å‹å­—æ®µä¸º 0ï¼Œå¸ƒå°”å­—æ®µä¸º false [JLS, 4.12.5]ã€‚å¦‚æœè¿™äº›å€¼å¯¹äºä»»ä½• transient å­—æ®µéƒ½æ˜¯ä¸å¯æ¥å—çš„ï¼Œåˆ™å¿…é¡»æä¾›ä¸€ä¸ª readObject æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è°ƒç”¨ defaultReadObject æ–¹æ³•ï¼Œç„¶åå°† transient å­—æ®µæ¢å¤ä¸ºå¯æ¥å—çš„å€¼ï¼ˆ[Item-88](https://github.com/clxering/Effective-Java-3rd-edition-Chinese-English-bilingual/blob/dev/Chapter-12/Chapter-12-Item-88-Write-readObject-methods-defensively.md)ï¼‰ã€‚æˆ–è€…ï¼Œå¯ä»¥é‡‡ç”¨å»¶è¿Ÿåˆå§‹åŒ–ï¼Œåœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨è¿™äº›å­—æ®µæ—¶åˆå§‹åŒ–å®ƒä»¬

**æ— è®ºé€‰æ‹©å“ªç§åºåˆ—åŒ–å½¢å¼ï¼Œéƒ½è¦åœ¨ç¼–å†™çš„æ¯ä¸ªå¯åºåˆ—åŒ–ç±»ä¸­å£°æ˜æ˜¾å¼çš„åºåˆ—ç‰ˆæœ¬ UIDã€‚**

å¥½å¤„æ˜¯ï¼š

1. æ¶ˆé™¤äº†åºåˆ—ç‰ˆæœ¬ UID æˆä¸ºä¸å…¼å®¹æ€§çš„æ½œåœ¨æ¥æºï¼ˆä¾‹å¦‚æ–°å¢æˆ–è€…å‡å°‘ä¸€ä¸ªå­—æ®µï¼‰
2. è·å¾—ä¸€ä¸ªå°çš„æ€§èƒ½ä¼˜åŠ¿ã€‚

å£°æ˜åºåˆ—ç‰ˆæœ¬ UID å¾ˆç®€å•ï¼Œåªè¦åœ¨ä½ çš„ç±»ä¸­å¢åŠ è¿™ä¸€è¡Œï¼š

```java
private static final long serialVersionUID = randomLongValue;
```

æ€»è€Œè¨€ä¹‹ï¼Œå¦‚æœä½ å·²ç»å†³å®šä¸€ä¸ªç±»åº”è¯¥æ˜¯å¯åºåˆ—åŒ–çš„ï¼ˆItem-86ï¼‰ï¼Œé‚£ä¹ˆè¯·ä»”ç»†è€ƒè™‘ä¸€ä¸‹åºåˆ—åŒ–çš„å½¢å¼åº”è¯¥æ˜¯ä»€ä¹ˆã€‚åªæœ‰åœ¨åˆç†æè¿°å¯¹è±¡çš„é€»è¾‘çŠ¶æ€æ—¶ï¼Œæ‰ä½¿ç”¨é»˜è®¤çš„åºåˆ—åŒ–å½¢å¼ï¼›å¦åˆ™ï¼Œè®¾è®¡ä¸€ä¸ªé€‚åˆæè¿°å¯¹è±¡çš„è‡ªå®šä¹‰åºåˆ—åŒ–å½¢å¼ã€‚è®¾è®¡ç±»çš„åºåˆ—åŒ–å½¢å¼åº”è¯¥å’Œè®¾è®¡å¯¼å‡ºæ–¹æ³•èŠ±çš„æ—¶é—´åº”è¯¥ä¸€æ ·å¤šï¼Œéƒ½åº”è¯¥ä¸¥è°¨å¯¹å¾…ï¼ˆItem-51ï¼‰ã€‚æ­£å¦‚ä¸èƒ½ä»æœªæ¥ç‰ˆæœ¬ä¸­åˆ é™¤å¯¼å‡ºçš„æ–¹æ³•ä¸€æ ·ï¼Œä¹Ÿä¸èƒ½ä»åºåˆ—åŒ–å½¢å¼ä¸­åˆ é™¤å­—æ®µï¼›å¿…é¡»æ°¸è¿œä¿å­˜å®ƒä»¬ï¼Œä»¥ç¡®ä¿åºåˆ—åŒ–å…¼å®¹æ€§ã€‚é€‰æ‹©é”™è¯¯çš„åºåˆ—åŒ–å½¢å¼å¯èƒ½ä¼šå¯¹ç±»çš„å¤æ‚æ€§å’Œæ€§èƒ½äº§ç”Ÿæ°¸ä¹…æ€§çš„è´Ÿé¢å½±å“ã€‚

---

***Reference***:

1. [Effective-Java-3rd-edition-Chinese-English-bilingual/Chapter-12-Item-87-Consider-using-a-custom-serialized-form.md at dev Â· clxering/Effective-Java-3rd-edition-Chinese-English-bilingual](https://github.com/clxering/Effective-Java-3rd-edition-Chinese-English-bilingual/blob/dev/Chapter-12/Chapter-12-Item-87-Consider-using-a-custom-serialized-form.md)
