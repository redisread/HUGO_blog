---
title: 3-ä½¿ç”¨ç§æœ‰æ„é€ å‡½æ•°æˆ–æšä¸¾ç±»å‹å®æ–½å•ä¾‹å±æ€§
date: 2021-10-21T14:23:06+08:00
description: Enforce the singleton property with a private constructor or an enum type.
draft: true
hideToc: false
enableToc: true
enableTocContent: false
tocPosition: outer
author: Victor
authorEmoji: ğŸ‘»
image:
plantuml: true
libraries:
- katex
- mathjax
tags:
- EffectiveJava
- å•ä¾‹æ¨¡å¼
series:
- EffectiveJava
categories:
-
---



<!--ç¬¬äºŒç« ï¼šåˆ›å»ºå’Œé”€æ¯å¯¹è±¡-->

### ä»€ä¹ˆæ˜¯å•ä¾‹ï¼Ÿ

å•ä¾‹æ˜¯ä¸€ä¸ªåªå®ä¾‹åŒ–ä¸€æ¬¡çš„ç±»ï¼Œå¹¶ä¸”é€šå¸¸è¡¨ç¤ºæ— çŠ¶æ€çš„å¯¹è±¡ã€‚



### å¦‚ä½•å®ç°å•ä¾‹

å•ä¾‹æ¨¡å¼çš„å®ç°ï¼Œä¸»è¦ç”±ä¸‰ä¸ªæ­¥éª¤ç»„æˆï¼Œå³ï¼š

1. å£°æ˜ä¸€ä¸ªé™æ€ç§æœ‰çš„æˆå‘˜å˜é‡ï¼›
2. ç§æœ‰åŒ–æ„é€ å‡½æ•°ï¼›
3. å£°æ˜ä¸€ä¸ªé™æ€å…±æœ‰çš„å‡½æ•°ï¼Œå‡½æ•°è¿”å›è¯¥å¯¹è±¡çš„å®ä¾‹ã€‚



å®ç°å•ä¾‹æœ‰ä¸¤ç§å¸¸è§çš„æ–¹æ³•ã€‚ä¸¤è€…éƒ½åŸºäº**ä¿æŒæ„é€ å‡½æ•°ç§æœ‰å’Œå¯¼å‡ºå…¬å…±é™æ€æˆå‘˜**ä»¥æä¾›å¯¹å”¯ä¸€å®ä¾‹çš„è®¿é—®ã€‚

#### æ–¹æ³•1ï¼šä½¿ç”¨å…¬æœ‰çš„finalåŸŸ

ä¸€æ—¦åˆå§‹åŒ–äº† Elvis ç±»ï¼Œå°±åªä¼šå­˜åœ¨ä¸€ä¸ª Elvis å®ä¾‹ï¼Œä¸å¤šä¹Ÿä¸å°‘ã€‚

```java
// Singleton with public final field
public class Elvis {
    public static final Elvis INSTANCE = new Elvis();
    private Elvis() { ... }
    public void leaveTheBuilding() { ... }
}
```

ä½†æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼šæ‹¥æœ‰ç‰¹æ®Šæƒé™çš„å®¢æˆ·ç«¯å¯ä»¥å€ŸåŠ© `AccessibleObject.setAccessible` æ–¹æ³•åˆ©ç”¨åå°„è°ƒç”¨ç§æœ‰æ„é€ å‡½æ•°ã€‚å¦‚æœéœ€è¦é˜²èŒƒè¿™ç§æ”»å‡»ï¼Œè¯·ä¿®æ”¹æ„é€ å‡½æ•°ï¼Œä½¿å…¶åœ¨è¯·æ±‚åˆ›å»ºç¬¬äºŒä¸ªå®ä¾‹æ—¶æŠ›å‡ºå¼‚å¸¸ã€‚

```java
Constructor<?>[] constructors = Elvis.class.getDeclaredConstructors();
AccessibleObject.setAccessible(constructors, true);

Arrays.stream(constructors).forEach(name -> {
    if (name.toString().contains("Elvis")) {
        Elvis instance = (Elvis) name.newInstance();
        instance.leaveTheBuilding();
    }
});
```



#### æ–¹æ³•2ï¼šä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•

å…¬å…±æˆå‘˜æ˜¯ä¸€ç§é™æ€å·¥å‚æ–¹æ³•ï¼Œæ‰€æœ‰å¯¹ `getInstance()` æ–¹æ³•çš„è°ƒç”¨éƒ½è¿”å›ç›¸åŒçš„å¯¹è±¡å¼•ç”¨ï¼Œå¹¶ä¸”ä¸ä¼šåˆ›å»ºå…¶ä»– Elvis å®ä¾‹ï¼ˆä¸å‰é¢æåˆ°çš„è­¦å‘Šç›¸åŒï¼‰ã€‚

```java
// Singleton with static factory
public class Elvis {
    private static final Elvis INSTANCE = new Elvis();
    private Elvis() { ... }
    public static Elvis getInstance() { return INSTANCE; }
    public void leaveTheBuilding() { ... }
}
```



> æ–¹æ³•1ä½¿ç”¨å…¬å…±å­—æ®µæ–¹æ³•çš„ä¸»è¦ä¼˜ç‚¹æ˜¯ API æ˜ç¡®äº†ç±»æ˜¯å•ä¾‹çš„ï¼špublic static ä¿®é¥°çš„å­—æ®µæ˜¯ final çš„ï¼Œå› æ­¤å®ƒæ€»æ˜¯åŒ…å«ç›¸åŒçš„å¯¹è±¡å¼•ç”¨ã€‚è€Œæ–¹æ³•2ä¼˜ç‚¹æ˜¯æ›´ç®€å•ã€‚



### åºåˆ—åŒ–çš„å®ç°

è¦ä½¿å•ä¾‹ç±»ä½¿ç”¨è¿™ä¸¤ç§æ–¹æ³•ä¸­çš„ä»»ä½•ä¸€ç§å®ç°å¯åºåˆ—åŒ–ï¼ˆChapter 12ï¼‰ï¼Œä»…ä»…åœ¨å…¶å£°æ˜ä¸­æ·»åŠ å®ç° serializable æ˜¯ä¸å¤Ÿçš„ã€‚è¦ç»´æŠ¤å•ä¾‹ä¿è¯ï¼Œåº”å£°æ˜æ‰€æœ‰å®ä¾‹å­—æ®µä¸º transientï¼Œå¹¶æä¾› readResolve æ–¹æ³•ï¼ˆ[Item-89](https://github.com/clxering/Effective-Java-3rd-edition-Chinese-English-bilingual/blob/dev/Chapter-12/Chapter-12-Item-89-For-instance-control-prefer-enum-types-to-readResolve.md)ï¼‰ã€‚å¦åˆ™ï¼Œæ¯æ¬¡ååºåˆ—åŒ–å®ä¾‹æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹ï¼Œåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œè¿™ä¼šå¯¼è‡´å‡ºç°è™šå‡çš„ Elvisã€‚

ä¸‹é¢è¿™ä¸ªæµ‹è¯•ç±»ï¼š

```java
public class SerializableTest {

    public static void main(String[] args) throws Exception {
        // åºåˆ—åŒ–Singletonå®ä¾‹
        serializable(Sigleton.getInstance(), "test");
        // ååºåˆ—åŒ–è¯¥å®ä¾‹
        Sigleton singleton = deserializable("test");
        // æ£€æŸ¥åºåˆ—åŒ–å‰å’Œåºåˆ—åŒ–åçš„å®ä¾‹æ˜¯å¦ç›¸ç­‰
        if (singleton != Sigleton.getInstance()) {
            System.out.println("singleton: " + singleton.toString());
            System.out.println("Singleton.getInstance: " + Sigleton.getInstance());
            System.out.println("two instances are different\n");
        } else {
            System.out.println("two instances are the same\n");
        }
    }

    //åºåˆ—åŒ–
    private static void serializable(Sigleton singleton, String filename) throws IOException {
        FileOutputStream fos = new FileOutputStream(filename);
        ObjectOutputStream oos = new ObjectOutputStream(fos);
        oos.writeObject(singleton);
        oos.flush();
    }

    //ååºåˆ—åŒ–
    @SuppressWarnings("unchecked")
    private static <T> T deserializable(String filename)
        throws IOException, ClassNotFoundException {
        FileInputStream fis = new FileInputStream(filename);
        ObjectInputStream ois = new ObjectInputStream(fis);
        return (T) ois.readObject();
    }
}


class Sigleton implements Serializable {

    private static final Sigleton INSTANCE = new Sigleton();

    private Sigleton() {
    }

    public static Sigleton getInstance() {
        return INSTANCE;
    }
}
```

è¿è¡Œä¹‹åè¾“å‡ºï¼š

```
two instances are different
```

æ˜¾ç¤ºä¸¤ä¸ªå•ä¾‹å¯¹è±¡ä¸æ˜¯åŒä¸€ä¸ªã€‚



å› ä¸ºéœ€è¦æä¾› readResolve æ–¹æ³•ï¼Œä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œå°†è¿™ä¸ª readResolve æ–¹æ³•æ·»åŠ åˆ° Elvis ç±»ä¸­ï¼š

```diff
class Sigleton implements Serializable {

    private static final Sigleton INSTANCE = new Sigleton();

    private Sigleton() {
    }

    public static Sigleton getInstance() {
        return INSTANCE;
    }

+    private Object readResolve() {
+        return INSTANCE;
+    }
}
```

æ­¤æ—¶èƒ½å¤Ÿåœ¨åºåˆ—åŒ–çš„æ—¶å€™å¾—åˆ°ä¸¤ä¸ªç›¸åŒçš„å•ä¾‹äº†ï¼š

```
two instances are the same
```



#### æ–¹æ³•3ï¼šå£°æ˜ä¸€ä¸ªå•å…ƒç´ æšä¸¾

è™½ç„¶åœ¨Sigletonå•ä¾‹ç±»ä¸­æ·»åŠ readResolveå‡½æ•°èƒ½å¤Ÿè§£å†³åºåˆ—åŒ–å•ä¾‹å¯¹è±¡çš„é—®é¢˜ï¼Œä½†æ˜¯åˆ©ç”¨æšä¸¾æ¥å¼ºåŒ–Singltonæ˜¯ä¸€ä¸ªæ›´å¥½çš„æ–¹æ³•ã€‚

è¿™ç§æ–¹æ³•å°±æ˜¯ä½¿ç”¨enumå°è£…äº†ä¸€ä¸ªå•ä¾‹çš„å®ä¾‹å¯¹è±¡ã€‚å› ä¸ºEnumè‡ªå¸¦åºåˆ—åŒ–çš„èƒ½åŠ›ï¼Œæ‰€ä»¥éå¸¸æ–¹ä¾¿ã€‚

```java
// Enum singleton - the preferred approach
public enum Elvis {
    INSTANCE;
    public void leaveTheBuilding() { ... }
}
```

å®é™…çš„ç®€å•ä¾‹å­å¦‚ä¸‹ï¼š

```java
public enum SingletonEnum {
    /** * å®ä¾‹ */
    INSTANCE,A;

    private String field;

    public String getField() {
        return field;
    }

    public void setField(String field) {
        this.field = field;
    }
}

// ä½¿ç”¨
SingletonEnum.INSTANCE.setField("123");
System.out.println(SingletonEnum.INSTANCE.getField());
```

è¿™ç§æ–¹æ³•ç±»ä¼¼äº public å­—æ®µæ–¹æ³•ï¼Œä½†æ˜¯å®ƒæ›´ç®€æ´ï¼Œé»˜è®¤æä¾›äº†åºåˆ—åŒ–æœºåˆ¶ï¼Œæä¾›äº†å¯¹å¤šä¸ªå®ä¾‹åŒ–çš„ä¸¥æ ¼ä¿è¯ï¼Œå³ä½¿é¢å¯¹å¤æ‚çš„åºåˆ—åŒ–æˆ–åå°„æ”»å‡»ä¹Ÿæ˜¯å¦‚æ­¤ã€‚è¿™ç§æ–¹æ³•å¯èƒ½æœ‰ç‚¹ä¸è‡ªç„¶ï¼Œä½†æ˜¯**å•å…ƒç´ æšä¸¾ç±»å‹é€šå¸¸æ˜¯å®ç°å•ä¾‹çš„æœ€ä½³æ–¹æ³•ã€‚** 



> æ³¨æ„ï¼Œå¦‚æœä½ çš„å•ä¾‹å¿…é¡»æ‰©å±•ä¸€ä¸ªè¶…ç±»è€Œä¸æ˜¯ Enumï¼ˆå°½ç®¡ä½ å¯ä»¥å£°æ˜ä¸€ä¸ª Enum æ¥å®ç°æ¥å£ï¼‰ï¼Œä½ å°±ä¸èƒ½ä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚



---

***Reference***:

1. [ç”¨ç§æœ‰æ„é€ å™¨æˆ–æšä¸¾æ¥å¼ºåŒ–å•ä¾‹å±æ€§ - æ—æœçš„åšå®¢ | BY horizonliu](https://horizonliu.github.io/2019/01/08/%E7%94%A8%E7%A7%81%E6%9C%89%E6%9E%84%E9%80%A0%E5%99%A8%E6%88%96%E6%9E%9A%E4%B8%BE%E6%9D%A5%E5%BC%BA%E5%8C%96%E5%8D%95%E4%BE%8B%E5%B1%9E%E6%80%A7/)
2. [Effective-Java-3rd-edition-Chinese-English-bilingual/Chapter-2-Item-3-Enforce-the-singleton-property-with-a-private-constructor-or-an-enum-type.md at dev Â· clxering/Effective-Java-3rd-edition-Chinese-English-bilingual](https://github.com/clxering/Effective-Java-3rd-edition-Chinese-English-bilingual/blob/dev/Chapter-2/Chapter-2-Item-3-Enforce-the-singleton-property-with-a-private-constructor-or-an-enum-type.md)

