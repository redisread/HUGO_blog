---
title: 微服务数据一致性
date: 2021-10-24T16:09:20+08:00
description:
draft: true
hideToc: false
enableToc: true
enableTocContent: false
tocPosition: outer
author: Victor
authorEmoji: 🪶
image: https://cos.jiahongw.com/uPic/cube.png
plantuml: true
libraries:
- katex
- mathjax
tags:
- 微服务
- 数据一致性
series:
- 微服务
- 架构
categories:
-
---





<!--《微服务数据一致性》-->

### 问题产生原因

微服务数据一致性问题产生原因



#### 微服务数据一致性案例



##### 1 缓存一致性问题

![缓存一致性问题](https://cos.jiahongw.com/uPic/image-20211024170854188.png)

根本原因：并发写导致缓存和数据库不一致。

##### 2 主从延迟问题

（主从副本一致性问题）

![主从延迟问题](https://cos.jiahongw.com/uPic/image-20211024172021548.png)

根本原因：主库和从库之间的数据存在延迟，当用户在从库查询数据的时候，可能不是一个最新的数据。（强制走主库可避免这个问题，但是主库的压力会很大）



##### 3 并发问题

![并发问题](https://cos.jiahongw.com/uPic/image-20211024173232733.png)

原因分析：并发产生了多条相同的数据，然后在下游没有进行幂等的处理。导致数据消费了多次。



##### 4 业务逻辑错误

![业务逻辑错误](https://cos.jiahongw.com/uPic/image-20211024174312513.png)

原因分析：没有对账机制（定位慢）；缺少异常补偿机制（处理低效）





---

总结产生的原因：

1. 多副本的数据一致性（缓存、主从）

   同一份数据的多个副本是一致的。在缓存和分布式系统中国，由于多个副本的数据不一致经常导致数据出现错误。

2. 分布式事务的数据一致性（并发、异常、逻辑）

   数据符合约束条件。在数据库和程序中，由于并发，异常和逻辑错误经常导致数据出现错误。



### 相关概念

数据一致性不是非黑即白：

- 强一致性
- 弱一致性
- 最终一致性（特例）



#### CAP原理

- C指的是强一致性。
- A：有限时间内返回数据。
- P：节点故障可以继续服务。

CAP告诉我们：任何情况下，三者都不能兼顾。只能在其中选择两个进行提高。



#### BASE理论	

BASE理论：满足P的情况下，对CA的权衡。

核心思想是即使无法做到强一致性，但是可以采用适当的方式达到最终一致性。

主要三点：

- 基本可用：在时间和功能体验上权衡。（例如0.5s返回不了1s是否可以接受）
- 软状态：在固定的时间内允许存在数据不一致。（但是最终的数据是一致的）
- 最终一致性：在不影响体验的前提下，通过异步和重试等方法达到最终一致性。



#### 刚性事务 & 柔性事务

##### **刚性事务**

刚性事务（如单数据库）完全遵循ACID规范，即数据库事务正确执行的四个基本要素：

- 原子性（Atomicity）
- 一致性（Consistency）
- 隔离性（Isolation）
- 持久性（Durability）



##### **柔性事务**

柔性事务（如分布式事务）为了满足可用性、性能与降级服务的需要，降低一致性（Consistency）与隔离性（Isolation）的要求，遵循BASE理论。



### 解决方案

#### 多副本数据一致性解决方案







#### 事务数据一致性解决方案

##### 淘汰缓存

核心原理：淘汰缓存而不是更新缓存。











#### 其他工具和方法









---

***Reference***:

1. [微服务数据一致性](https://daxue.sankuai.com/personal.html#!/courseCenter/course/120413?series_id=120415)
2. [MySQL主从数据库同步延迟问题解决-阿里云开发者社区](https://developer.aliyun.com/article/42638)
3. [MySQL主从数据库同步延迟问题解决 - Go语言编程](https://gobea.cn/blog/detail/g61KXk59.html)
4. [一分钟弄清楚事务四要素：ACID | 凝雨 - Yun | 快乐编程每一天 - Happy Coding Every Day](https://ningyu1.github.io/20200325/one-minute-transaction-ACID.html)

