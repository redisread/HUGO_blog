---
title: "UE4æ¸²æŸ“è¿‡ç¨‹"
date: 2020-05-29T9:42:11+08:00
description:
draft: false
hideToc: false
enableToc: true
enableTocContent: false
tocPosition: inner
author: Victor
authorEmoji: ğŸ‘»
image: https://i.loli.net/2020/05/29/yO1bzGwBSflsVYj.png
libraries:
- katex
- mathjax
tags:
- C++
- UE4
- Game
series:
- Game
categories:
-
---



# UE4æ¸²æŸ“è¿‡ç¨‹

https://answers.unrealengine.com/questions/17862/access-color-and-depth-buffer-of-each-frame.html

https://segmentfault.com/a/1190000012737548





<img src="https://i.loli.net/2020/05/30/P6KEDtS1HkOg9fF.jpg" alt="preview" style="zoom: 200%;" />

## ç›¸å…³æœ¯è¯­

**RHI**

æ¸²æŸ“ç¡¬ä»¶æ¥å£ï¼Œæ˜¯ä¸ºä¸åŒå¹³å°æŠ½è±¡å‡ºä¸åŒå›¾å½¢APIçš„ä¸€å±‚ã€‚æ‰€æœ‰æ¸²æŸ“å‘½ä»¤å‡é€šè¿‡RHIå±‚ä¼ é€’ï¼Œä»¥è½¬æ¢ä¸ºé€‚ç”¨çš„æ¸²æŸ“å™¨ã€‚

**å»¶è¿Ÿæ¸²æŸ“**

è™šå¹»å¼•æ“4ä¸­çš„é»˜è®¤æ¸²æŸ“å™¨ã€‚å®ƒå› å°†ç…§æ˜/é˜´å½±è®¡ç®—æ¨è¿Ÿåˆ°å…¨å±è¿‡ç¨‹è€Œä¸æ˜¯ç»˜åˆ¶æ¯ä¸ªç½‘æ ¼æ—¶è€Œå¾—åã€‚

**é¡¶ç‚¹å·¥å‚**

é¡¶ç‚¹å·¥å‚æ˜¯å°è£…é¡¶ç‚¹æ•°æ®æºå¹¶é“¾æ¥åˆ°é¡¶ç‚¹ç€è‰²å™¨ä¸Šçš„è¾“å…¥çš„ç±»ã€‚é™æ€ç½‘æ ¼ç‰©ä½“ï¼Œéª¨æ¶ç½‘æ ¼ç‰©ä½“å’Œè¿‡ç¨‹ç½‘æ ¼ç»„ä»¶å‡ä½¿ç”¨ä¸åŒçš„é¡¶ç‚¹å·¥å‚ã€‚

**ç€è‰²å™¨**

åœ¨è™šå¹»å¼•æ“ä¸­ï¼Œç€è‰²å™¨æ˜¯HLSLä»£ç ï¼ˆä»¥.ush / .usfæ–‡ä»¶çš„å½¢å¼ï¼‰å’Œæè´¨å›¾çš„å†…å®¹çš„ç»„åˆã€‚åœ¨Unrealä¸­åˆ›å»ºæè´¨æ—¶ï¼Œå®ƒä¼šæ ¹æ®è®¾ç½®ï¼ˆå¦‚ç€è‰²æ¨¡å¼ï¼‰å’Œç”¨æ³•æ¥ç¼–è¯‘å¤šä¸ªç€è‰²å™¨æ’åˆ—ã€‚



## å®æ—¶æ¸²æŸ“æµç¨‹ï¼š

![1](https://i.loli.net/2020/05/30/qU8vN2WZVbt9hkF.jpg)

2

![2](https://i.loli.net/2020/05/30/3trKVpOMU5sTQfB.jpg)

[Gbuffæ•°æ®](https://zhuanlan.zhihu.com/p/36840778)ï¼š

![img](https://i.loli.net/2020/05/30/LFU1RtqDN5gvdSm.jpg)





## æ¸²æŸ“æµç¨‹ï¼š

é¦–å…ˆï¼Œè™šå¹»çš„æ¸²æŸ“ç”±ä¸‰ä¸ªçº¿ç¨‹å…±åŒå®Œæˆã€‚åˆ†åˆ«æ˜¯CPUçº¿ç¨‹ï¼ŒDRAWçº¿ç¨‹ï¼Œå’ŒGPUçº¿ç¨‹ã€‚

çŸ¥ä¹ï¼šhttps://zhuanlan.zhihu.com/p/57158725

![æ¸²æŸ“æµæ°´çº¿](https://i.loli.net/2020/05/30/YZuyDGO7c3mRXfd.jpg)

**é®æŒ¡å¤„ç†**

é®æŒ¡å¤„ç†éƒ¨åˆ†ä¸»è¦è¿è¡Œåœ¨Drawçº¿ç¨‹ï¼Œå‰é¢è¯´è¿‡ï¼Œå®ƒå†³å®šäº†å“ªäº›å¯¹è±¡æœ€ç»ˆä¼šå‚ä¸æ¸²æŸ“ã€‚

è™šå¹»ä¸»è¦æœ‰4ç§é®æŒ¡å¤„ç†æ–¹æ¡ˆã€‚åˆ†åˆ«æ˜¯è·ç¦»å‰”é™¤ï¼Œè§†é”¥å‰”é™¤ï¼Œé¢„è®¡ç®—å¯è§æ€§å’Œé®æŒ¡å‰”é™¤ã€‚è¿™å››ç§å‰”é™¤æ–¹æ¡ˆè¦æŒ‰ç…§æ€§èƒ½æ¶ˆè€—ä»å°åˆ°å¤§çš„é¡ºåºæ‰§è¡Œï¼Œè¿™å››ç§å‰”é™¤æ–¹æ¡ˆè¦æŒ‰ç…§æ€§èƒ½æ¶ˆè€—ä»å°åˆ°å¤§çš„é¡ºåºæ‰§è¡Œã€‚

åŸå›¾ï¼š

![SceneView.png](https://i.loli.net/2020/05/30/1WhCoPUJBHsqMOG.jpg)

å‰”é™¤ï¼š

![åœºæ™¯è§†å›¾](https://i.loli.net/2020/05/30/soT4dgIb5eqhkCr.jpg)

è§†é”¥ä½“å‰”é™¤ï¼š

![ViewFrustumDiagram.png](https://i.loli.net/2020/05/30/q6s3kzjgxPlS1DV.jpg)

1. **è¿‘ç«¯è£åˆ‡å¹³é¢ï¼ˆNear Clipping Planeï¼‰** æ˜¯èƒ½å¤Ÿçœ‹åˆ°å¯¹è±¡çš„æœ€æ¥è¿‘æ‘„åƒæœºçš„ç‚¹ã€‚
2. **æ‘„åƒæœºè§†é”¥ï¼ˆCamera Frustumï¼‰** æ˜¯è¿‘ç«¯å’Œè¿œç«¯è£åˆ‡å¹³é¢ä¹‹é—´çš„å¯è§†æŸ¥çœ‹åŒºåŸŸçš„é‡‘å­—å¡”å½¢çŠ¶è¡¨ç¤ºã€‚
3. **è¿œç«¯è£åˆ‡å¹³é¢ï¼ˆFar Clipping Planeï¼‰** æ˜¯èƒ½å¤Ÿçœ‹åˆ°å¯¹è±¡çš„ç¦»æ‘„åƒæœºæœ€è¿œçš„ç‚¹ã€‚

> åœ¨å…³å¡è§†å£ä¸­ç¼–è¾‘æ—¶ï¼Œé€‰æ‹© æ˜¾ç¤ºï¼ˆShowï¼‰>é«˜çº§ï¼ˆAdvancedï¼‰ å¹¶å¯ç”¨ æ‘„åƒæœºè§†é”¥ï¼ˆCamera Frustumï¼‰ï¼Œå¯ä»¥æ˜¾ç¤ºè§†å›¾è§†é”¥ã€‚



**å‡ ä½•ä½“æ¸²æŸ“**

è¿›å…¥å®é™…æ¸²æŸ“ï¼Œæˆ‘è§‰å¾—æ˜¯åœ¨DrawCallçº¿ç¨‹æ‰§è¡Œçš„`Prepass/Early Z Pass`

> åœ¨æ¸²æŸ“å‡ ä½•ä½“ä¹‹å‰ï¼Œæˆ‘ä»¬ä¼šé¢ä¸´ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†å“ªäº›å¯¹è±¡è¦å‚ä¸æ¸²æŸ“ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸çŸ¥é“è¯¥ä»¥ä»€ä¹ˆæ ·çš„é¡ºåºæ¥æ¸²æŸ“è¿™äº›å¯¹è±¡ï¼Œä¹Ÿä¸çŸ¥é“å“ªä¸ªå¯¹è±¡åœ¨å“ªä¸ªå¯¹è±¡çš„å‰é¢ã€‚

Prepass/Early Z Pass

è™šå¹»å¼•æ“é’ˆå¯¹è¿™ä¸€é—®é¢˜ï¼Œä¼šåœ¨å®é™…æ¸²æŸ“å‰æ‰§è¡Œä¸€ä¸ªPrepassæˆ–EarlyZPassè¿›è¡Œä¼˜åŒ–ã€‚ä½ å¯ä»¥æŠŠè¿™ä¸ªç©æ„ç®€å•ç†è§£ä¸ºä¸€ç§é¢„æ¸²æŸ“ï¼Œè¿™ä¸ªé¢„æ¸²æŸ“å¹²çš„äº‹æƒ…å¾ˆç®€å•ï¼Œå°±æ˜¯è¿›è¡Œä¸€ä¸ªæ¯”è¾ƒè½»é‡çš„æ¸²æŸ“è®¡ç®—ï¼Œå¾—å‡ºå“ªä¸ªå¯¹è±¡åœ¨å“ªä¸ªçš„å‰é¢ï¼Œå¹¶æŠŠé‚£ç§æ˜çŸ¥ä¼šè¢«åæ¥æ¸²æŸ“çš„å¯¹è±¡æ‰€æŒ¡ä½çš„åƒç´ åŒºåŸŸç»™é®ä½ï¼ˆmaskoutï¼‰ã€‚

Drawcall

DrawCallæ˜¯ä¼šè¢«æ¸²æŸ“çš„å•ä¸€å…ƒç´ ï¼Œæ¯æ¸²æŸ“ä¸€ä¸ªDrawCallå°±æ˜¯ä¸€æ¬¡ç»˜åˆ¶è°ƒç”¨ã€‚

> å…±äº«ç›¸åŒå±æ€§çš„ä¸€ç»„å¤šè¾¹å½¢å°±æ˜¯ä¸€ä¸ªDrawCallï¼Œæ¯ä¸€ä¸ªæè´¨ä¹Ÿæ˜¯ä¸€ä¸ªDrawCallï¼ˆä¸€ä¸ªæ¨¡å‹æ‹¥æœ‰10ä¸ªæè´¨ï¼Œé‚£å°±æ˜¯10ä¸ªDrawCallï¼‰ã€‚DrawCallè¶Šå¤šï¼Œç»˜åˆ¶è°ƒç”¨è¶Šå¤šï¼Œæ€§èƒ½è¶Šä½ã€‚



å›¾ç¤ºé¢„æ¸²æŸ“(`PrePass`)

![æ¸²æŸ“å›¾ç‰‡](https://i.loli.net/2020/05/30/u6bz1W8oG2DdP4r.jpg)

ï¼ˆæŒ‰ç…§ä»å·¦åˆ°å³çš„é¡ºåºï¼‰

![presspass](https://i.loli.net/2020/05/30/69WCi3JRAj8gXZm.jpg)









## UE4æ¸²æŸ“ä¸€å¸§

![img](https://interplayoflight.files.wordpress.com/2017/10/image2.png?w=515&h=708)

### ParticleSimulation

**ç²’å­æ¨¡æ‹Ÿ**



### Z-Prepass

ä¼šæœ‰ä¸€ç³»åˆ—çš„cullingè¿‡ç¨‹å‰”é™¤æ‰ä¸éœ€è¦çš„åƒç´ æˆ–è€…å‡ ä½•ä½“,å°†æ‰€æœ‰ä¸é€æ˜çš„ç½‘æ ¼æ¸²æŸ“åˆ°R24G8æ·±åº¦ç¼“å†²åŒºï¼š

> å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“æ¸²æŸ“åˆ°æ·±åº¦ç¼“å†²åŒºæ—¶ï¼Œè™šå¹»ä½¿ç”¨[åå‘Z](https://developer.nvidia.com/content/depth-precision-visualized)ï¼Œè¿™æ„å‘³ç€å°†è¿‘å¹³é¢æ˜ å°„ä¸º1ï¼Œå°†è¿œå¹³é¢æ˜ å°„ä¸º0ã€‚è¿™å¯ä»¥åœ¨æ·±åº¦èŒƒå›´å†…æä¾›æ›´å¥½çš„ç²¾åº¦ï¼Œå¹¶å‡å°‘å¯¹è¿œè·ç¦»ç½‘æ ¼ç‰©ä½“çš„Zè§’å¯¹æŠ—ã€‚ ã€‚

### BeginOcclusionTests

**æµ‹è¯•å’¬åˆ**,å¤„ç†æ¡†æ¶ä¸­çš„æ‰€æœ‰é®æŒ¡æµ‹è¯•.è™šå¹»å¼•æ“é»˜è®¤ä½¿ç”¨ç¡¬ä»¶é®æŒ¡æŸ¥è¯¢è¿›è¡Œé®æŒ¡æµ‹è¯•







UDrawFrustumComponent







